// Generated by CoffeeScript 1.3.1
(function() {

  define(["smog/server", "smog/util", "smog/notify", "smog/editor", "templates/edit", "templates/collection"], function(server, util, notify, editor, templ, collection) {
    return function(_arg) {
      var edit, name, realname;
      name = _arg.name;
      realname = name.toLowerCase();
      $('#content').append(templ({
        title: 'Map Reduce',
        id: realname,
        button: 'Execute'
      }));
      edit = editor.create("" + realname + "-edit-view", {
        mode: "javascript",
        worker: false,
        wrap: 100,
        value: "//This is a simple map/reduce that counts documents by name\n{\n  map: function () {\n    emit(this.name, {count: 1});\n  },\n  reduce: function (key, values) {\n    var result = 0;\n    values.forEach(function (value) {\n      result += value.count;\n    });\n    return {count: result};\n  }\n}"
      });
      $('#edit-modal').modal();
      $('#edit-modal').on('hidden', function() {
        edit.destroy();
        return $('#edit-modal').remove();
      });
      return $('#edit-button').click(function() {
        $('#edit-modal').modal('hide');
        return server.collection({
          collection: realname,
          type: 'mapReduce',
          query: edit.getSession().getValue()
        }, function(err, docs, stat) {
          if (err != null) {
            return notify.error("Error retrieving documents: " + err);
          }
          console.log(docs, stat);
          return $('#content').html(collection({
            name: name,
            documents: util.filterDocuments(docs)
          }));
        });
      });
    };
  });

}).call(this);
